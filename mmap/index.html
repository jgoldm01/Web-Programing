<!DOCTYPE html>
<html>
  <head>
    <title>Marauder's Map</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <link rel="stylesheet" href="style.css" type="text/css" />

    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script>
      /* initialize the map */
      var map;
      var infowindow = new google.maps.InfoWindow();
      function initialize() {
        var bostonLat = 42.3581;
        var bostonLng = -71.0636;
        var mapOptions = {
          zoom: 11,
          center: new google.maps.LatLng(bostonLat, bostonLng)
        };
        map = new google.maps.Map(document.getElementById('map-canvas'),
            mapOptions);
        
        var image = 'eric.png'
        windowContent = "ME. latitude: " + bostonLat + " longitude: " + bostonLng;
        make_marker(bostonLat, bostonLng, 'eric.png', windowContent);

        var xhr = new XMLHttpRequest();
        var params = "login=EricCartman&lat=" + bostonLat + "&lng=" + bostonLng;
        xhr.open("POST", "http://chickenofthesea.herokuapp.com/sendLocation", true);
        
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.setRequestHeader("Content-length", params.length);
        xhr.setRequestHeader("Connection", "close");

        xhr.onreadystatechange = function() {
          if (xhr.readyState == 4) {
            var loc = JSON.parse(xhr.responseText);
            parse_loc(loc);
          }
        };
        xhr.send(params)

        function parse_loc(loc) {
          for (i = 0; i < loc.characters.length; i++) {
            name = loc.characters[i].name;
            img = name + '.png';
            lat = loc.characters[i].loc.latitude;
            lng = loc.characters[i].loc.longitude;
            note = loc.characters[i].loc.note;
            windowContent = "name: " + name + " latitude: " + lat + " longitude: "
                            + lng + " note: " + note;
            make_marker(lat, lng, img, windowContent);
          }
          for (i = 0; i < loc.students.length; i++) {
            login = loc.students[i].login;
            lat = loc.students[i].lat;
            lng = loc.students[i].lng;
            timeStamp = loc.students[i].created_at;
            windowContent = 'login: ' + login + ' latitude: ' + lat + 'longitude: '
                            + lng + ' timeStamp: ' + timeStamp;
            make_marker(lat, lng, 'student', windowContent);
          }
        }



        function make_marker(lat, lng, img, windowContent) {
          if (img == 'student') {
            var marker = new google.maps.Marker({
              position: new google.maps.LatLng(lat, lng),
              map: map,
              title: img
            });
          } else {
            var marker = new google.maps.Marker({
              position: new google.maps.LatLng(lat, lng),
              map: map,
              icon: img,
              title: img
            });
          }

            google.maps.event.addListener(marker, 'click', function() {
              infowindow.close();
              infowindow.setContent(windowContent);
              infowindow.open(map, this);
            }); 
        }
      }

    google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
    <div id="map-canvas"></div>
  </body>
</html>
